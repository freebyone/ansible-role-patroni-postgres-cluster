- name: Check cluster status
  uri:
    url: "http://{{ inventory_hostname }}:{{ patroni_restapi_port }}/cluster"
    method: GET
  register: cluster_info
  delegate_to: "{{ inventory_hostname }}"
  run_once: true

- name: Get primary node name
  set_fact:
    primary_node_name: "{{ cluster_info.json.members | selectattr('role', 'match', '(master|leader)') | map(attribute='name') | first }}"
  run_once: true
  delegate_to: "{{ inventory_hostname }}"

- name: Debug primary node
  debug:
    msg: "Primary node is: {{ primary_node_name }}"
  run_once: true

- name: Create PostgreSQL users and databases
  block:
    - name: Create users
      shell: |
        {{ postgresql_base_command }} psql {{ postgresql_connection_params }} -c "CREATE USER {{ item.name }} WITH PASSWORD '{{ item.password }}';" || echo "User already exists"
      loop: "{{ users }}"
      delegate_to: "{{ primary_node_name }}"
      run_once: true
      ignore_errors: true

    - name: Create databases
      shell: |
        {{ postgresql_base_command }} psql {{ postgresql_connection_params }} -c "CREATE DATABASE {{ item.name }} WITH OWNER {{ item.owner }} ENCODING '{{ item.encoding | default('UTF8') }}';" || echo "Database already exists"
      loop: "{{ databases }}"
      delegate_to: "{{ primary_node_name }}"
      run_once: true
      ignore_errors: true

    - name: Grant privileges
      shell: |
        {{ postgresql_base_command }} psql -h localhost -U postgres -p {{ postgresql_port }} -w -d {{ item.db_name }} -c "GRANT {{ item.privileges }} ON ALL TABLES IN SCHEMA '{{ item.schema | default('public') }}' TO {{ item.user }};"
      loop: "{{ privileges }}"
      delegate_to: "{{ primary_node_name }}"
      run_once: true
  when: management_postgres | bool

- name: Configure PgBouncer in container
  block:
    - name: Create PgBouncer configuration
      template:
        src: pgbouncer.ini.j2
        dest: "{{ pgbouncer_config_dir }}/pgbouncer.ini"
        owner: "{{ patroni_postgres_user }}"
        group: "{{ patroni_postgres_group }}"
        mode: '0640'
      when:
        - with_pgbouncer == true

    - name: Create userlist file
      template:
        src: userlist.txt.j2
        dest: "{{ pgbouncer_config_dir }}/userlist"
        owner: "{{ patroni_postgres_user }}"
        group: "{{ patroni_postgres_group }}"
        mode: '0640'
      when:
        - with_pgbouncer == true

    - name: Create PgBouncer log directory
      shell: |
        {{ postgresql_base_command }} mkdir -p /var/log/pgbouncer
        {{ postgresql_base_command }} chown postgres:postgres /var/log/pgbouncer
      delegate_to: "{{ primary_node_name }}"
      run_once: true

    - name: Create PgBouncer run directory
      shell: |
        {{ postgresql_base_command }} mkdir -p /var/run/pgbouncer
        {{ postgresql_base_command }} chown postgres:postgres /var/run/pgbouncer
      delegate_to: "{{ primary_node_name }}"
      run_once: true

    - name: Start PgBouncer in container
      shell: |
        {{ postgresql_base_command }} pgbouncer -d /etc/pgbouncer/pgbouncer.ini
      delegate_to: "{{ primary_node_name }}"
      run_once: true
      async: 10
      poll: 0

    - name: Wait for PgBouncer to start
      wait_for:
        host: "{{ primary_node_name }}"
        port: "{{ pgbouncer_port }}"
        timeout: 30
      run_once: true

  when: 
    - create_db | bool
    - with_pgbouncer == true
    - primary_node_name is defined