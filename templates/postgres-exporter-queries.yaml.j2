---
pg_database:
  query: "SELECT d.datname, d.datistemplate, d.datallowconn, pg_database_size(d.datname) as size_bytes FROM pg_database d WHERE d.datallowconn"
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - datistemplate:
        usage: "LABEL"
        description: "Is this database a template?"
    - datallowconn:
        usage: "LABEL"
        description: "Is connection allowed to this database?"
    - size_bytes:
        usage: "GAUGE"
        description: "Disk space used by the database"

pg_stat_user_tables:
  query: |
    SELECT schemaname, relname, seq_scan, seq_tup_read, idx_scan, idx_tup_fetch,
           n_tup_ins, n_tup_upd, n_tup_del, n_tup_hot_upd, n_live_tup, n_dead_tup,
           n_mod_since_analyze, last_vacuum, last_autovacuum, last_analyze,
           last_autoanalyze, vacuum_count, autovacuum_count, analyze_count,
           autoanalyze_count
    FROM pg_stat_user_tables
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema that this table is in"
    - relname:
        usage: "LABEL"
        description: "Name of the table"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans initiated on this table"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Number of live rows fetched by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans initiated on this table"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of live rows fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of rows updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of rows deleted"
    - n_tup_hot_upd:
        usage: "COUNTER"
        description: "Number of rows HOT updated"
    - n_live_tup:
        usage: "GAUGE"
        description: "Estimated number of live rows"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Estimated number of dead rows"

pg_replication:
  query: |
    SELECT client_addr, usename, application_name, state, sync_state,
           pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) as sent_lag_bytes,
           pg_wal_lsn_diff(sent_lsn, write_lsn) as write_lag_bytes,
           pg_wal_lsn_diff(write_lsn, flush_lsn) as flush_lag_bytes,
           pg_wal_lsn_diff(flush_lsn, replay_lsn) as replay_lag_bytes,
           pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as total_lag_bytes
    FROM pg_stat_replication
  metrics:
    - client_addr:
        usage: "LABEL"
        description: "Client IP address"
    - usename:
        usage: "LABEL"
        description: "User name"
    - application_name:
        usage: "LABEL"
        description: "Application name"
    - state:
        usage: "LABEL"
        description: "Replication state"
    - sync_state:
        usage: "LABEL"
        description: "Synchronization state"
    - sent_lag_bytes:
        usage: "GAUGE"
        description: "Bytes not sent yet"
    - write_lag_bytes:
        usage: "GAUGE"
        description: "Bytes sent but not written"
    - flush_lag_bytes:
        usage: "GAUGE"
        description: "Bytes written but not flushed"
    - replay_lag_bytes:
        usage: "GAUGE"
        description: "Bytes flushed but not replayed"
    - total_lag_bytes:
        usage: "GAUGE"
        description: "Total replication lag in bytes"

patroni_cluster_info:
  query: |
    SELECT 
      pg_is_in_recovery() as in_recovery,
      pg_last_wal_receive_lsn() as receive_lsn,
      pg_last_wal_replay_lsn() as replay_lsn,
      pg_last_xact_replay_timestamp() as replay_timestamp,
      CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END as is_replica
  metrics:
    - in_recovery:
        usage: "GAUGE"
        description: "Is the node in recovery mode? (1 for replica, 0 for primary)"
    - is_replica:
        usage: "GAUGE"
        description: "Is this a replica? (1 for replica, 0 for primary)"
    - receive_lsn:
        usage: "LABEL"
        description: "Last WAL receive LSN"
    - replay_lsn:
        usage: "LABEL"
        description: "Last WAL replay LSN"
    - replay_timestamp:
        usage: "LABEL"
        description: "Last transaction replay timestamp"