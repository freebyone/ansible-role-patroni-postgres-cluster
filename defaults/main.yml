---
flush_all: false
new_cluster: false
with_pgbouncer: true
create_db: false
with_backup: false

patroni_base_dir: "/data/patroni-postgres-cluster"
patroni_config_dir: "{{ patroni_base_dir }}/patroni"
postgresql_data_dir: "{{ patroni_base_dir }}/data/{{ postgresql_version }}/"
postgresql_wal_dir: "{{ patroni_base_dir }}/wal"
pgbouncer_config_dir: "{{ patroni_base_dir }}/pgbouncer"
postgresql_backup_dir: "{{ patroni_base_dir }}/backups"
postgres_backup_script_path: "/data/backups"
postgres_home_dir: "/var/lib/postgresql"
patroni_home_dir: "/home/postgres/postgres.yml"
pgbouncer_log_dir: "/var/log/{{ patroni_cluster_name }}/pgbouncer"
wal_g_dir: "{{ patroni_base_dir }}/wal-g/env"

patroni_docker_image: "ghcr.io/zalando/spilo-17:4.0-p3"
postgresql_version: 17

patroni_cluster_name: "patroni-postgres-cluster"
patroni_scope: "{{ patroni_cluster_name }}"
patroni_service_name: "{{ patroni_cluster_name }}"

etcd_api_version: "v3"
etcd_servers: "{% for host in groups['etcd_cluster'] %}{{ hostvars[host].ansible_host | default(host) }}:{{ etcd_client_port | default(2379) }}{% if not loop.last %},{% endif %}{% endfor %}"
patroni_restapi_port: 8008
postgresql_port: 5432
pgbouncer_port: 6432

# SSL for PostgreSQL
postgresql_ssl_enabled: true
postgresql_ssl_cert_src: "files/ssl/postgresql/server.crt"
postgresql_ssl_key_src: "files/ssl/postgresql/server.key"
postgresql_ssl_ca_src: "files/ssl/postgresql/ca.crt"
postgresql_ssl_cert_file: "server.crt"
postgresql_ssl_key_file: "server.key"
postgresql_ssl_ca_file: "ca.crt"
postgresql_ssl_dir: "{{ patroni_config_dir }}/ssl"

# SSL for Patroni REST API
patroni_restapi_ssl_enabled: false
patroni_ssl_cert_src: "files/ssl/patroni/cert.pem"
patroni_ssl_key_src: "files/ssl/patroni/key.pem"
patroni_ssl_ca_src: "files/ssl/patroni/ca.pem"
patroni_ssl_cert_path: "{{ patroni_config_dir }}/ssl/cert.pem"
patroni_ssl_key_path: "{{ patroni_config_dir }}/ssl/key.pem"
patroni_ssl_ca_path: "{{ patroni_config_dir }}/ssl/ca.pem"

# SSL for PgBouncer
pgbouncer_ssl_enabled: false
pgbouncer_ssl_cert_path: "{{ pgbouncer_config_dir }}/ssl/cert.pem"
pgbouncer_ssl_key_path: "{{ pgbouncer_config_dir }}/ssl/key.pem"
pgbouncer_ssl_ca_path: "{{ pgbouncer_config_dir }}/ssl/ca.pem"


postgres_password_encryption_method: md5 # md5 or scram-sha-256

patroni_postgres_group: "postgres"
patroni_postgres_user: "postgres"
replication_password: "postgres"
postgres_superuser_password: "postgres"
postgres_admin_users: "postgres"
patroni_restapi_username: "patroni"
patroni_restapi_password: "patroni"
monitoring_user: "stats_user"

wal_g_s3_prefix: "s3://your-bucket-name/patroni-cluster/"
wal_g_aws_access_key_id: "your-access-key"
wal_g_aws_secret_access_key: "your-secret-key"
wal_g_aws_region: "your-region"
wal_g_aws_endpoint: "endpoint"  # For S3 services
wal_g_compression_method: "lz4"
wal_g_delta_max_steps: 7
wal_g_upload_concurrency: 4
wal_g_download_concurrency: 4
wal_g_upload_disk_concurrency: 2

pgbouncer_auth_password: "pgbouncer_password"
monitoring_password: "monitoring_password"

postgresql_parameters:
  max_connections: "100"
  shared_buffers: "512MB"
  work_mem: "4MB"
  maintenance_work_mem: "64MB"
  effective_cache_size: "1GB"
  wal_level: "logical"
  max_wal_senders: "10"
  max_replication_slots: "10"
  wal_keep_size: "1GB"
  wal_buffers: "16MB"
  effective_io_concurrency: "200"
  min_wal_size: "1GB"
  max_wal_size: "2GB"
  max_prepared_transactions: "64"
  shared_preload_libraries: "pg_stat_statements"
  default_statistics_target: "100"
  superuser_reserved_connections: "3"
  tcp_keepalives_idle: "60"
  tcp_keepalives_interval: "10"
  tcp_keepalives_count: "3"
  idle_in_transaction_session_timeout: "60000"
  lock_timeout: "30000"
  statement_timeout: "60000"

backup_retention_days: 30
backup_schedule: "0 2 * * *"

# PostgreSQL base command
postgresql_base_command: "docker exec {{ patroni_cluster_name }}"

# PostgreSQL connection parameters
postgresql_connection_params: "-h localhost -U postgres -p {{ postgresql_port }} -w -d postgres"
postgresql_base_psql_command: "{{ postgresql_base_command }} psql {{ postgresql_connection_params }}"

postgresql_check_user_command: "{{ postgresql_base_psql_command }} -t -c \"SELECT 1 FROM pg_user WHERE usename='{{ item.name }}';\""
postgresql_check_db_command: "{{ postgresql_base_psql_command }} -t -c \"SELECT 1 FROM pg_database WHERE datname='{{ item.name }}';\""



users:
  - name: appuser
    password: appuser
    connlimit: 10
  - name: appuser2
    password: appuser2
    connlimit: 5
  - name: appuser3
    password: appuser3

databases:
  - name: app
    owner: appuser
    encoding: UTF8
    connlimit: 50
  - name: app2
    owner: appuser2
    encoding: UTF8

privileges:
  - db_name: app
    user: appuser3
    privileges: "SELECT, INSERT"
  - db_name: app2
    user: appuser3
    privileges: "SELECT, INSERT"



pgbouncer_pool_mode: transaction
pgbouncer_server_idle_timeout: 7000
pgbouncer_client_idle_timeout: 3000
pgbouncer_max_client_conn: 100
pgbouncer_default_pool_size: 20
pgbouncer_admin_users: "postgres"
pgbouncer_stats_users: "{{ monitoring_user }}"
pgbouncer_verbose: 0


pgbouncer_connection_params: "-h localhost -U postgres -p {{ pgbouncer_port }} -w -d pgbouncer"